### Deny crawlers without 403 response.
if ($http_user_agent ~* (?:httrack|htmlparser|libwww|pecl|automaticsitemap|clicksense|valueclick|sitebot|buzztracker)) {
  return 444;
}

## The 'default' location.
location / {
	## Try static files, if not found, redirect it to Drupal
	try_files $uri @drupal;
	## Drupal 404 from can impact performance. If using a module like
	## search404 then 404's *have *to be handled by Drupal. Uncomment to
	## relay the handling of 404's to Drupal.
	## error_page 404 /index.php;
}

## Allow php files to be excuted
## It's very important that php files under sites/.*/files are not allowed to be excuted!
location ~ (?!/sites/[^/]+/files/).*\.php$ {
	include fastcgi_params;
	fastcgi_pass unix:/var/run/php5-fpm.sock;
}

location @drupal {
	# Some modules enforce no slash (/) at the end of the URL. Else this rewrite block wouldn't be needed (GlobalRedirect)
	rewrite ^/(.*)$ /index.php?q=$1 last;
}

## If accessing an image generated by imagecache, serve it directly if
## available, if not relay the request to Drupal to (re)generate the
## image.
location ~* /sites/[^/]+/files/(imagecache|styles)/ {
	access_log off;
	try_files $uri @drupal;
}

## Static files
location ~ \.(css|js|html|xml)$ {
	access_log off;
	expires 5d;
	## No need to bleed constant updates. Send the all shebang in one
	## fell swoop.
	tcp_nodelay off;
}

## Multimedia files
location ~* \.(avi|mpg|mpeg|wav|midi|m4a|mp3|mp4|mov|ogg|flv|swf|pdf|jpg|jpeg|gif|bmp|ico|png)$ {
	expires 30d;
	## No need to bleed constant updates. Send the all shebang in one
	## fell swoop.
	tcp_nodelay off;
}

## Trying to access private files directly returns a 404.
location ~* ^/sites/.*/files/private/ {
	internal;
}

### Deny direct access to backups.
location ~* /sites/[^/]+/(files|private)/backup_migrate/ {
	access_log off;
	return 404;
}

## Hide CHANGELOG.txt etc. the text files under / root folder
location ~* ^/[^/]+\.txt$ {
	return 404;
}

## Replicate the Apache <FilesMatch> directive of Drupal standard
## .htaccess. Disable access to any code files. Return a 404 to curtail
## information disclosure. Hide also the text files.
location ~* /\.(htaccess|git|svn|hg)$ {
	return 404;
}
location ~* \.(make|engine|inc|info|install|module|profile|patch|po|sh|sql|theme|tpl(\.php)?)$ {
	return 404;
}
## Disallow access to patches/backup directory.
location ^~ /(patches|backup) {
	return 404;
}

## Disable access logs for robots.txt.
location = /robots.txt {
	allow all;
	access_log off;
}

## Support for favicon. Return a 204 (No Content) if the favicon
## doesn't exist.
location = /favicon.ico {
	access_log off;
	log_not_found off;
	try_files /favicon.ico =204;
}
